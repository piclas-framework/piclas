# Mesh Generation

## Mesh generation/conversion with HOPR

**PICLas** utilizes computational meshes from the high order preprocessor **HOPR** in HDF5 format.
It is available under GPLv3 at [https://github.com/hopr-framework/hopr](https://github.com/hopr-framework/hopr).
The design philosophy is that all tasks related to mesh organization, different input formats and the construction of high order
geometrical mappings are separated from the *parallel* simulation code. These tasks are implemented most efficiently in a *serial*
environment.
The employed mesh format is designed to make the parallel read-in process as simple and fast as possible.
For details concerning the mesh format please refer to the
[HOPR HDF5 Curved Mesh Format Documentation](https://www.hopr-project.org/upload/e/e6/MeshFormat.pdf).
Installation instructions can be found [here](https://github.com/hopr-framework/hopr/blob/master/INSTALL.md).

Using **HOPR**, simple, structured meshes can be directly created using an
[in-built mesh generator.](https://www.hopr-project.org/index.php/Inbuilt_Mesh_Generators).
A number of strategies to create curved boundaries are also included in HOPR.
More complex geometries can be treated by importing meshes generated by external mesh generators in CGNS or GMSH format
([Example parameter file](https://www.hopr-project.org/index.php/External_Meshes)).
Detailed instructions for some mesh generators that we have experience with (GridPro, HEXPRESS, MeshGems within SALOME and CENTAUR) are given below.

The basic command for either mesh generation or conversion of an external mesh is

~~~~~~~
hopr hopr.ini
~~~~~~~

Note that the path to the **HOPR** executable is omitted in the command (visit {ref}`sec:directory-paths`).

### Mesh generation with HEXPRESS

#### Hexpress Setup
Download HEXPRESS from the official website and install the program. Execute the configure script under
```
/usr/numeca/COMMON/configure
```

Add the licence server (e.g. to *.bashrc*)
```
NUMECA_LICENSE_FILE=@name_server
export NUMECA_LICENSE_FILE
```
where *name_servers* is the server alias or address.
Next, adjust the *.driver * file in the *.numeca* directory.
```
~/.numeca/.driver
```
with the following line
```
name_server localhost OPENGL:OPENGL2:X11 X11
```

#### Hexpress Usage
CAD model of complete fluid domain with FreeCAD -> Export as STL. CATIA, SolidWorks formats also supported by HEXPRESS.

Export as CGNS (ADF)

HOPR: CGNS 3.3.1

### Mesh generation with GridPro

[GridPro](https://www.gridpro.com/) is a proprietary conforming multi-block mesh generator with hexahedral elements. However,
a free academic version limited to 250 blocks is available.

After mesh generation, and before naming the boundaries in the *Property Setter*, you should set the output format to STARCD.
Make sure to define not only labels but also different properties for the boundaries. Then export as STARCD and you will get
four output files. During the export GridPro loses the label information, thus the boundary names have to be set again in the
*.inp file. An example of a correct *.inp is given below:

    TITLE
    Converted from GridPro v4.1
    CTAB 1 FLUI
    CTNA 1 ZONE_VOL
    RDEF 1 WALL $ $ $ $ $ $ $ $
    RNAM 1 BC_WALL
    RDEF 2 CYCL $ $ $ $ $ $ $ $
    RNAM 2 BC_CYCL
    VREAD,/home/user/mesh/test.vrt,,1,43770,CODE
    CREAD,/home/user/mesh/test.cel,,1,21504,MODI,CODE
    BREAD,/home/user/mesh/test.bnd,,1,43768,MODI,CODE

HOPR can then read-in the mesh with following mode option:

    Mode = 4

More recent versions of GridPro also support a CGNS output. Here, the option *Export* -> *Grid* -> *CGNS* -> *Elementary* should
be chosen. For different boundary labels, different property types have to be defined (Note: The property type *Wall* might be
causing problems during the HOPR read-in and should be avoided). The following errors can be ignored as long as HOPR finishes
successfully and a mesh file is written out

    ERROR: number of zones in inifile does not correspond to number of zones in meshfile(s)
    ERROR - Could not find corresponding boundary definition of ws.Interblck

### Mesh generation with CENTAUR

A conventional tetrahedral mesh can be generated with CENTAUR. Boundaries have to be set in CENTAUR and accordingly in the HOPR
parameter file. During the export as CGNS the following options are required:

* Check "Only write out boundary faces"
* Check "Write out boundary faces grouped by panels"

Read-in and convert with HOPR and the following options:

    Mode = 3
    BugFix_ANSA_CGNS = TRUE
    SplitToHex = TRUE

Should problems occur try to set SpaceQuandt to a higher value, e.g. 100. During the pre-processing step every tetrahedron will be
converted to 4 hexahedra, resulting in increased number of elements.

### Mesh generation with MeshGems/SALOME

*Note: This tutorial was last updated/used: June 2016*

[MeshGems-Hexa](https://www.meshgems.com/volume-meshing-meshgems-hexa.html) is proprietary automated all-hex mesh generator.
The algorithm can be used a plug-in within the open-source platform [SALOME](https://www.salome-platform.org/). At the time, we do
not have a MeshGems-Hexa license and cannot give any support on mesh generation.

* Import geometry as STEP or IGS
* Create groups in Geometry module for the boundary conditions
  * Right-click on the imported file in Object Browser -> "Create Group"
  * Select faces as "Share Type" (2D object)
  * Choose appropriate name for the BC
  * Select one or many surfaces by (shift-) clicking on the surfaces
  * Click "Add" when finished for a single BC
  * "Apply" to save the BC and repeat the process (or "Apply and Close" at the end)
* Create mesh in Mesh module: "Mesh" -> "Create mesh"
    * Choose the imported geometry in "Geometry" (if not already chosen, when geometry was highlighted previously)
    * Choose MG-Hexa for the 3D algorithm
    * Choose MG-CADsurf for the 2D algorithm
* Assign boundary conditions to mesh
    * Right-click on created mesh
    * "Create groups from Geometry"
      * Click on the BC in "Object Browser" in the "Geometry"-tree
      * "Apply" and repeat with the next BC
      * "Apply and close" with the last BC
* Export mesh as CGNS
    * Right-click on mesh, choose "Export" -> "CGNS file"
    * Import the exported CGNS file
    * Check the names of boundary conditions
      * Activate the BC by clicking on the visibility icon next to the name
      * Change the name to correspond to the entry in the preproc.ini
    * Export the modified mesh again as CGNS
* Convert CGNS mesh from hdf to adf format
        Install cgns-tools ("sudo apt-get install cgns-tools")
        "hdf2adf filename"

Read-in and convert with HOPR and the following options:

    Mode = 3
    BugFix_ANSA_CGNS = TRUE

