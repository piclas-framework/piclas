# Visualization & Output

In general, simulation results are either available as particle data, spatially resolved variables based on the mesh (classic CFD results) and/or as integral values (e.g. for reservoir/heat bath simulations). The piclas2vtk tool converts the HDF5 files generated by **PICLas** to the binary VTK format, readable by many visualization tools like ParaView and VisIt. The tool is executed by

~~~~~~~
piclas2vtk [posti.ini] output.h5
~~~~~~~

Multiple HDF5 files can be passed to the piclas2vtk tool at once. The (optional) runtime parameters to be set in `posti.ini` are given below:

|   **Option**  | **Default** |                                     **Description**                                    |
|   :--------:  | :---------: |                                       :---------:                                      |
|     NVisu     |      1      |             Number of points at which solution is sampled for visualization            |
| VisuParticles |     OFF     |      Converts the particle data (positions, velocity, species, internal energies)      |
|  NodeTypeVisu |     VISU    | Node type of the visualization basis: VISU,GAUSS,GAUSS-LOBATTO,CHEBYSHEV-GAUSS-LOBATTO |

In the following, the parameters enabling the different output variables are described. It should be noted that these parameters are part of the `parameter.ini` required by **PICLas**.

## Particle Data

At each `Analyze_dt` as well as at the start and end of the simulation, the state file (`*_State_*.h5`) is written out, which contains the complete particle information such as their positions, velocity vector, species and internal energy values.

To sample the particles impinging on a certain surface between `Analyze_dt` outputs, the following option can be enabled per boundary condition

    Part-Boundary1-BoundaryParticleOutput = T

The particle data will then be written to `*_PartStateBoundary_*.h5` and includes besides the position, velocity vector and kinetic energy (in eV), additionally the impact obliqueness angle between particle trajectory and surface normal vector, e.g. an impact vector perpendicular to the surface corresponds to an impact angle of $0^{\circ}$. This allows you to create a histogram of the particle impacts in the post-processing.

The output of lost particles in a separate `*_PartStateLost*.h5` file can be enabled by

    CountNbrOfLostParts = T

It includes particles lost during the tracking (TrackingMethod = triatracking, tracing) as well as during the restart procedure.
For the latter, the output includes particles that went missing but were found on other processors.

## Field Solver and PIC

The following table summarizes the available fields in connection with Poisson's or Maxwell's equations (some require a particle
solver to be active) that can be stored to the state file (`*_State_*.h5`) file at every `Analyze_dt` as well as at the start and
end of the simulation

|         **Option**         | **Default** |                                        **Description**                                       |
|         :--------:         | :---------: |                                          :---------:                                         |
|      PIC-OutputSource      |      F      |                             charge $\rho$ and current density $j$                            |
| CalcElectricTimeDerivative |      F      | time derivative $\frac{\partial D}{\partial t}=\varepsilon_{0}\frac{\partial E}{\partial t}$ |

When running a PIC simulation, the particle-grid deposited properties, such as charge and current densities (in each direction `x,
y,`and `z`) can be output by enabling

    PIC-OutputSource = T

that stores the data in the same format as the solution polynomial of degree $N$, i.e., $(N+1)^{3}$ data points for each cell.

The temporal change of the electric displacement field $\frac{\partial D}{\partial t}=\varepsilon_{0}\frac{\partial E}{\partial t}$
can be stored for Poisson's equation (`PICLAS_EQNSYSNAME=poisson`) by setting

    CalcElectricTimeDerivative = T

Again, the data in the same format as the solution polynomial of degree $N$, i.e., $(N+1)^{3}$ data points for each cell in the
container `DG_TimeDerivative` in the `*_State_*.h5` file and can be converted to `.vtk` format with `piclas2vtk`.

### Element-polynomial field properties
In general, the data is the same format as the solution polynomial of degree $N$, i.e., $(N+1)^{3}$ data points for each cell in the
respective container in the `.h5` files and can be converted to `.vtk` format with `piclas2vtk`. The resolution of the converted
data can be adjusted by setting `NVisu` to any integer value, which is the used for the interpolation of the original data.


**External electromagnetic field vector**
When using external electromagnetic fields, either via a constant vector

    PIC-externalField = (/ 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 /)

or a cell-local polynomial distribution calculated via `superB` by

    PIC-BGFileName = BGField.h5

the resulting electromagnetic field, that is used by the PIC solver in addition to the calculated fields (superposition), can be
visualized via

    CalcEMFieldOutput = T

and the resulting data (vector fields for *E* and *B*) is stored in `PROJECT_PIC-EMField.h5`.

### Element-constant field/particle properties
The determined properties are given by a single value within each cell and are NOT sampled over time as opposed to the output
described in Section {ref}`sec:sampled-flow-field-and-surface-variables`.
These parameters are only available for PIC simulations, are part of the regular state file (as a separate container within the
HDF5 file) and automatically included in the conversion to the VTK format. They are written to `PROJECT_Solution_000.000*.h5` and
after conversion are found in `PROJECT_ElemData_000.000*.vtu`.

**Power Coupled to Particles**
The energy transferred to particles during the push (acceleration due to electromagnetic fields) is
determined by using

    CalcCoupledPower = T

which calculates the time-averaged power (moving average) coupled to the particles in each cell (average power per cubic metre)
and stores it in `PCouplDensityAvgElem` for each species separately. Additionally, the properties `PCoupl` (instantaneous) and a
time-averaged (moving average) value
`PCoupledMoAv` are stored in the `ParticleAnalyze.csv` output file.

**Plasma Frequency**
The (cold) plasma frequency can be calculated via

$$\omega_{p}=\omega_{e}=\sqrt{\frac{e^{2}n_{e}}{\varepsilon_{0}m_{e}}}$$

which is the frequency with which the charge density of the electrons oscillates, where
$\varepsilon_{0}$ is the permittivity of vacuum, $e$ is the elementary charge, $n_{e}$ and $m_{e}$
are the electron density and mass, respectively.
The calculation is activated by

    CalcPlasmaFreqeuncy = T

**PIC Particle Time Step**
The maximum allowed time step within the PIC schemes can be estimated by

$$\Delta_{t,\mathrm{PIC}}<\frac{0.2}{\omega_{p}}$$

where $\omega_{p}$ is the (cold) plasma frequency.
The calculation is activated by

    CalcPICTimeStep = T

**Debye length**
The Debye length can be calculated via

$$\lambda_{D}=\sqrt{\frac{\varepsilon_{0}k_{B}T_{e}}{e^{2}n_{e}}}$$

where $\varepsilon_{0}$ is the permittivity of vacuum, $k_{B}$ is the Boltzmann constant, $e$ is the
elementary charge and $T_{e}$ and $n_{e}$ are the electron temperature and density, respectively.
The Debye length measures the distance after which the magnitude of the electrostatic
potential of a single charge drops by $1/\text{e}$.
The calculation is activated by

    CalcDebyeLength = T

**Points per Debye Length**
The spatial resolution in terms of grid points per Debye length can be estimated via

$$\mathrm{PPD}=\frac{\lambda_{D}}{\Delta x}=\frac{(p+1)\lambda_{D}}{L}\sim 1$$

where $\Delta x$ is the grid spacing (average spacing between grid points),
$p$ is the polynomial degree of the solution, $\lambda_{D}$ is the Debye length and $L=V^{1/3}$
is the characteristic cell length, which is determined from the volume $V$ of the grid cell.
Furthermore, the calculation in each direction $x$, $y$ and $z$ is performed by setting
$L=\left\{ L_{x}, L_{y}, L_{z} \right\}$, which are the average distances of the bounding box of
each cell. These values are especially useful when dealing with Cartesian grids.
The calculation is activated by

    CalcPointsPerDebyeLength = T

**PIC CFL Condition**
The plasma frequency time step restriction and the spatial Debye length restriction can be merged
into a single parameter

$$\frac{\Delta t}{0.4 \Delta x}\sqrt{\frac{k_{b}T_{e}}{m_{e}}}= \frac{(p+1)\Delta t}{0.4 L}\sqrt{\frac{k_{b}T_{e}}{m_{e}}} \lesssim 1$$

where $\Delta t$ is the time step, $\Delta x$ is the grid spacing (average spacing between grid
points), $p$ is the polynomial degree of the solution, $k_{B}$ is the Boltzmann constant, $T_{e}$
and $m_{e}$ are the electron temperature and mass, respectively. Furthermore, the calculation in
each direction $x$, $y$ and $z$ is performed by setting $L=\left\{ L_{x}, L_{y}, L_{z} \right\}$,
which are the average distances of the bounding box of each cell.
These values are especially useful when dealing with Cartesian grids.
The calculation is activated by

    CalcPICCFLCondition = T

**Maximum Particle Displacement**
The largest displacement of a particle within one time step $\Delta t$ is estimated for each cell
via

$$\frac{\mathrm{max}(v_{\mathrm{iPart}})\Delta t}{\Delta x}=\frac{(p+1)\mathrm{max}(v_{\mathrm{iPart}})\Delta t}{L} < 1$$

which means that the fastest particle is not allowed to travel over the length of two grid points
separated by $\Delta x$.
Furthermore, the calculation in each direction $x$, $y$ and $z$ is performed by setting
$L=\left\{ L_{x}, L_{y}, L_{z} \right\}$, which are the average distances of the bounding box of
each cell.
These values are especially useful when dealing with Cartesian grids.
The calculation is activated by

    CalcMaxPartDisplacement = T

**Electron Cyclotron Motion**
The gyrokinetic or cyclotron motion of electrons can be analyzed by calculating the cyclotron frequency
for the non-relativistic case

$$\omega_c = \frac{eB}{m_{e}}$$

|    Symbol   |                             Parameter                             |
| ----------- |                            -----------                            |
|  $\omega_c$ |               cyclotron frequency (non-relativistic)              |
|     $e$     |         elementary charge (of an electron, absolute value)        |
|     $B$     | magnitude of the magnetic flux density at the electron's position |
|    $m_e$    |                         electron rest mass                        |

or if the electron velocity is considered to be relativistic (automatic switch), the following formula is used

$$\omega_c = \frac{eB}{\gamma m_e} = \frac{eB}{m_e\sqrt{1-v_e^2/c^2}}$$

|    Symbol   |                             Parameter                             |
| ----------- |                            -----------                            |
|  $\omega_c$ |               cyclotron frequency     (relativistic)              |
|     $e$     |         elementary charge (of an electron, absolute value)        |
|     $B$     | magnitude of the magnetic flux density at the electron's position |
|   $\gamma$  |                           Lorentz factor                          |
|    $m_e$    |                         electron rest mass                        |
|    $v_e$    |                       magnitude of velocity                       |
|     $c$     |                           speed of light                          |

and, hence, the required time step (Boris push)

$$\Delta t = \frac{0.02}{\omega_c}$$

to resolve the gyro motion adequately by setting the following two parameters

    CalcPICTimeStepCyclotron = T
    CalcCyclotronFrequency   = T

The first activates the calculation of the smallest time step in each cell (only regarding the cyclotron motion, not other
restrictions) and the second activates the calculation of the min/max value of the cyclotron frequency (and also radius) for each
cell. The containers that are written to `.h5` (and converted to `.vtu`) are

    PICTimeStepCyclotronCell

for the time step restriction and

    CyclotronFrequencyMaxCell
    CyclotronFrequencyMinCell
    GyroradiusMinCell
    GyroradiusMaxCell

for the cyclotron frequency and radius (min/max values).

### Time-averaged Fields
At each `Analyze_dt` and at the end of the simulation, additional time-averaged field properties can be written to `*_TimeAvg_*.h5`
by enabling

    CalcTimeAverage = T

where the averaging will take place over the time spanned between two `Analyze_dt` outputs. The time-averaged values and
fluctuations are selected via `VarNameAvg` and `VarNameFluc`, depending on the equation system that is solved (Poisson or Maxwell).
These properties are stored in the same format as the solution polynomial of degree $N$, i.e., $(N+1)^{3}$ data points for each cell.
For Maxwell's equations, the following properties are available

    VarName{Avg,Fluc} = ElectricFieldX
    VarName{Avg,Fluc} = ElectricFieldY
    VarName{Avg,Fluc} = ElectricFieldZ
    VarName{Avg,Fluc} = MagneticFieldX
    VarName{Avg,Fluc} = MagneticFieldY
    VarName{Avg,Fluc} = MagneticFieldZ
    VarName{Avg,Fluc} = Phi
    VarName{Avg,Fluc} = Psi
    VarName{Avg,Fluc} = ElectricFieldMagnitude
    VarName{Avg,Fluc} = MagneticFieldMagnitude
    VarName{Avg,Fluc} = PoyntingVectorX
    VarName{Avg,Fluc} = PoyntingVectorY
    VarName{Avg,Fluc} = PoyntingVectorZ
    VarName{Avg,Fluc} = PoyntingVectorMagnitude

and for Poisson's equation

    VarName{Avg,Fluc} = Phi
    VarName{Avg,Fluc} = ElectricFieldX
    VarName{Avg,Fluc} = ElectricFieldY
    VarName{Avg,Fluc} = ElectricFieldZ
    VarName{Avg,Fluc} = ElectricFieldMagnitude



In case of a PIC simulation, the particle-grid deposited properties (via the user-selected deposition method) are also available via
`VarNameAvg` and `VarNameFluc`

    VarName{Avg,Fluc} = PowerDensityX-Spec0x
    VarName{Avg,Fluc} = PowerDensityY-Spec0x
    VarName{Avg,Fluc} = PowerDensityZ-Spec0x
    VarName{Avg,Fluc} = PowerDensity-Spec0x
    VarName{Avg,Fluc} = ChargeDensity-Spec0x
    VarName{Avg,Fluc} = ChargeDensityX-Spec0x
    VarName{Avg,Fluc} = ChargeDensityY-Spec0x
    VarName{Avg,Fluc} = ChargeDensityZ-Spec0x
    VarName{Avg,Fluc} = ChargeDensity-Spec0x

which must be supplied for each particle species `x` separately.

(sec:sampled-flow-field-and-surface-variables)=
## Particle Flow and Surface Sampling

Flow field and surface outputs are available when the DSMC, BGK and FP methods are utilized (standalone or coupled with PIC) and
stored in `*_DSMCState_*.h5`. A sampling over a certain number of iterations is performed to calculate the average macroscopic
values such as number density, bulk velocity and temperature from the microscopic particle information. Two variants are available
in PICLas, allowing to sample a certain amount of the simulation duration or to sample continuously during the simulation and
output the result after the given number of iterations.

The first variant is usually utilized to sample at the end of a simulation, when the steady state condition is reached. The first
parameter `Part-TimeFracForSampling` defines the percentage that shall be sampled relative to the simulation end time $T_\mathrm{end}$
(Parameter: `TEnd`)

    Part-TimeFracForSampling = 0.1
    Particles-NumberForDSMCOutputs = 2

`Particles-NumberForDSMCOutputs` defines the number of outputs during the sampling time. Example: The simulation end time is
$T_\mathrm{end}=1$, thus sampling will begin at $T=0.9$ and the first output will be written at $T=0.95$. At this point the sample
will NOT be resetted but continued. Therefore, the second and last output at $T=T_\mathrm{end}=1.0$ is not independent of the
previous result but contains the sample of the complete sampling duration. It should be noted that if a simulation is continued
at e.g. $T=0.95$, sampling with the given parameters will begin immediately.

The second variant can be used to produce outputs for unsteady simulations, while still to be able to sample for a number of
iterations (Parameter: `Part-IterationForMacroVal`). The first two flags allow to enable the output of flow field/volume and
surface values, respectively.

    Part-WriteMacroVolumeValues = T
    Part-WriteMacroSurfaceValues = T
    Part-IterationForMacroVal = 100

Example: The simulation end time is $T_\mathrm{end}=1$ with a time step of $\Delta t = 0.001$. With the parameters given above,
we would sample for 100 iterations up to $T = 0.1$ and get the first output. Afterwards, the sample is deleted and the sampling
begins anew for the following output at $T=0.2$. This procedure is repeated until the simulation end, resulting in 10 outputs with
independent samples.

Parameters indicating the quality of the simulation (e.g. the maximal collision probability in case of DSMC) can be enabled by

    Particles-DSMC-CalcQualityFactors = T

Output and sampling on surfaces can be enabled by

    Particles-DSMC-CalcSurfaceVal = T

By default this will include the species-specific impact counter per iteration of simulation particles, the force per area in $x$,
$y$, and $z$ and the heat flux. The output of the surface-sampled data is written to `*_DSMCSurfState_*.h5`. Additional surface
values can be sampled by using

    CalcSurfaceImpact = T

which calculates the species-dependent averaged impact energy (trans, rot, vib, elec), impact vector, impact obliqueness angle
(between particle trajectory and surface normal vector, e.g. an impact vector perpendicular to the surface corresponds to an
impact angle of $0^{\circ}$), number of real particle impacts over the sampling duration and number of real particle impacts
per area per second.

## Integral Variables

WIP, PartAnalyze/FieldAnalyze

